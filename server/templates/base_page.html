<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="shortcut icon" href="/static/img/favicon-centered.png">
    <meta charset="utf-8">
    <title>{% block page_title %}{% endblock %}{{ ' - ' if self.page_title() else '' }} Flow</title>
    <meta name="description" content="Plan your university courses with friends in mind.">
    <meta name="author" content="Flow">

    <!-- CSS stylesheets -->
    <link rel="stylesheet"
    href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600">
    <link rel="stylesheet" href="{{ '/static/css/ext.css'|version }}">
    {% block stylesheets %}
    {% endblock %}

    <!-- Javascript -->
    {% block head_scripts %}
    {% endblock %}

    <script>
      window.pageData = {};
      window.pageData.env = '{{ env }}';
      {% if current_user_id %}
        window.pageData.currentUserId = {{ current_user_id|tojson|safe }};
      {% endif %}
      {% if page_script %}
        window.pageData.pageScript = '{{ ('/static/%s/%s' % (js_dir, page_script))|version }}';
      {% endif %}
    </script>

    <script async data-main="{{ '/static/%s/main.js' % js_dir }}" src="{{ ('/static/%s/ext/require-2.0.6.js' % js_dir)|version }}">
    </script>

    {# Google Analytics #}
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', '{{ ga_property_id }}']);
      _gaq.push(['_trackPageview']);
      if ('{{ env }}' == 'dev') {
        _gaq.push(['_setDomainName', 'none']);
      }

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>

    {# Mixpanel #}
    <script type="text/javascript">
      (function(c,a){window.mixpanel=a;var b,d,h,e;b=c.createElement("script");b.type="text/javascript";b.async=!0;b.src=("https:"===c.location.protocol?"https:":"http:")+'//cdn.mxpnl.com/libs/mixpanel-2.1.min.js';d=c.getElementsByTagName("script")[0];d.parentNode.insertBefore(b,d);a._i=[];a.init=function(b,c,f){function d(a,b){var c=b.split(".");2==c.length&&(a=a[c[0]],b=c[1]);a[b]=function(){a.push([b].concat(Array.prototype.slice.call(arguments,0)))}}var g=a;"undefined"!==typeof f?
      g=a[f]=[]:f="mixpanel";g.people=g.people||[];h="disable track track_pageview track_links track_forms register register_once unregister identify name_tag set_config people.identify people.set people.increment".split(" ");for(e=0;e<h.length;e++)d(g,h[e]);a._i.push([b,c,f])};a.__SV=1.1})(document,window.mixpanel||[]);
      {# TODO(Sandy): Change the dev key to a completely different account so
                      we don't waste data points #}
      if ({{ env|tojson|safe }} == 'prod') {
        mixpanel.init("0a5e88bd3f288fe8a2d8adf94b452212");
      } else {
        mixpanel.init("31525266c483a1eb7fdb9353474370c9");
      }

      {% if current_user %}
        {# We want these "Super Properties" sent on every event #}
        {# TODO(Sandy): keep this for when we run out of users slots? verify #}
        mixpanel.register({user_id: '{{ current_user.id }}'});

        mixpanel.people.identify({user_id: '{{ current_user.id }}'});
        mixpanel.people.set({
          $created: new Date(1000 * {{ current_user.join_date.strftime('%s') }}),
          $email: {{ current_user.email|tojson|safe }},
          $first_name: {{ current_user.first_name|tojson|safe }},
          $last_name: {{ current_user.last_name|tojson|safe }},
          $last_login: new Date(),
          Courses: {{ current_user.course_history|length }},
          Friends: {{ current_user.friend_ids|length }},
          Gender: {{ current_user.gender|tojson|safe }},
          Profile: {{ current_user.absolute_profile_url|tojson|safe }},
          Program: {{ current_user.short_program_name|tojson|safe }},
          Year: {{ current_user.last_program_year_id|tojson|safe }}
        });
        {% if current_user.name -%}
          mixpanel.name_tag({{ current_user.name|tojson|safe }});
        {%- endif %}
      {% endif %}
    </script>
  </head>

  <body>
    {# TODO(david): Real responsive layout:
         http://twitter.github.com/bootstrap/scaffolding.html#responsive #}
    <div id="fb-root"></div>

    <div class="navbar navbar-static-top">
      <div class="container-fluid">
        <a class="brand" href="/">
          <i class="logo logo-no-color"></i>
          <i class="logo logo-color"></i>
          <span class="beta" title="We're currently in closed beta for UW Accounting and Finance! We'll be opening up to more programs soon!">SAF Beta</span>
        </a>
        <ul class="nav pull-right">
          <li class="{{ 'active' if nav_item == 'courses' else '' }}">
            <a href="/courses"><i class="icon-reorder"></i> Search Courses</a>
          </li>
          {% if current_user %}
            <li class="{{ 'active' if nav_item == 'profile' else '' }}">
              <a href="/profile"><i class="icon-user"></i> Profile</a>
            </li>
            <li class="divider-vertical"></li>
            <li>
              <a href="/?logout=1"><i class="icon-signout"></i></a>
            </li>
          {% endif %}
        </ul>
      </div>
    </div>
    {% if not current_user_id %}
      <div id="sign-in-banner-container"></div>
    {% endif %}
    <header>
      {% block header %}
      {% endblock %}
    </header>

    <div class="container-fluid">
      {% block body %}
      {% endblock %}
    </div>

    <footer>
      {% block footer %}
      {% endblock %}
    </footer>

    {% block templates %}
    {% endblock %}

    {# TODO(mack): rename js_vars?
        Put json data passed from backend here under window.pageData.
        Since the script for specific to this page does not run until
        domready, it should be safe to init data here #}
    {% block scripts %}
    {% endblock %}

    {# UserVoice #}
    {% if nav_item != 'landing' %}
    <script type="text/javascript">
      var uvOptions = {};
      (function() {
        var uv = document.createElement('script'); uv.type = 'text/javascript'; uv.async = true;
        uv.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'widget.uservoice.com/TfZSPWdiQIEAbHMnlV7w.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(uv, s);
      })();
    </script>
    {% endif %}

    {# Intercom.io #}
    {% if current_user and current_user.email %}
      <script id="IntercomSettingsScriptTag">
        var intercomSettings = {
          app_id: '4ytbu7ss',
          email: {{ current_user.email|tojson|safe }},
          created_at: {{ current_user.join_date.strftime('%s') }},
          user_id: '{{ current_user.id }}',
          {% if current_user.name -%}
            name: {{ current_user.name|tojson|safe }},
          {%- endif %}
          custom_data: {
            friends: {{ current_user.friend_ids|length }},
            program: {{ current_user.short_program_name|tojson|safe }},
            year: {{ current_user.last_program_year_id|tojson|safe }},
            courses: {{ current_user.course_history|length }},
            profile: {{ current_user.absolute_profile_url|tojson|safe }}
          }
        };
      </script>
      <script>
        (function() {
          var i=function(){i.c(arguments)};i.q=[];
          i.c=function(args){i.q.push(args)};window.Intercom=i;
          function async_load() {
            var s = document.createElement('script');
            s.type = 'text/javascript'; s.async = true;
            s.src = 'https://api.intercom.io/api/js/library.js';
            var x = document.getElementsByTagName('script')[0];
            x.parentNode.insertBefore(s, x);
          }
          if (window.attachEvent) {
            window.attachEvent('onload', async_load);
          } else {
            window.addEventListener('load', async_load, false);
          }
        })();
      </script>
    {% endif %}

  </body>
</html>
